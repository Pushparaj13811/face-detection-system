<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Face Recognition Capture</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      /* Modern Retro Color Palette */
      :root {
        --background-color: #f4f1de;
        --primary-color: #3d405b;
        --secondary-color: #e07a5f;
        --accent-color: #81b29a;
        --text-color: #2c3e50;
        --highlight-color: #f2cc8f;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: "Courier New", Courier, monospace;
      }

      body {
        background-color: var(--background-color);
        color: var(--text-color);
        line-height: 1.6;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
        background-image: linear-gradient(
            45deg,
            rgba(255, 255, 255, 0.1) 25%,
            transparent 25%
          ),
          linear-gradient(-45deg, rgba(255, 255, 255, 0.1) 25%, transparent 25%);
        background-size: 50px 50px;
        background-position: 0 0, 25px 25px;
      }

      .container {
        background-color: var(--background-color);
        border: 3px solid var(--primary-color);
        box-shadow: 10px 10px 0 var(--secondary-color);
        max-width: 800px;
        width: 100%;
        padding: 30px;
        text-align: center;
        position: relative;
        overflow: hidden;
      }

      .container::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: repeating-linear-gradient(
          transparent 0,
          transparent 7px,
          rgba(0, 0, 0, 0.05) 7px,
          rgba(0, 0, 0, 0.05) 14px
        );
        transform: rotate(-45deg);
        pointer-events: none;
        z-index: 1;
      }

      h1 {
        color: var(--primary-color);
        margin-bottom: 25px;
        font-size: 2.2rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 2px;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
      }

      h1::after {
        content: "";
        position: absolute;
        bottom: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 100px;
        height: 4px;
        background-color: var(--secondary-color);
      }

      h1 i {
        color: var(--secondary-color);
      }

      #webcam,
      #imagePreview {
        width: 100%;
        max-width: 500px;
        border: 3px solid var(--primary-color);
        margin-bottom: 20px;
        display: none;
      }

      .btn-container {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 20px;
      }

      .capture-btn,
      .upload-btn,
      .match-btn {
        background-color: var(--primary-color);
        color: var(--background-color);
        border: 2px solid var(--text-color);
        padding: 12px 25px;
        font-size: 1rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
      }

      .capture-btn:hover,
      .upload-btn:hover,
      .match-btn:hover {
        background-color: var(--secondary-color);
        color: var(--background-color);
      }

      .capture-btn::before,
      .upload-btn::before,
      .match-btn::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: rgba(255, 255, 255, 0.1);
        transform: rotate(-45deg);
        transition: all 0.3s ease;
        opacity: 0;
      }

      .capture-btn:hover::before,
      .upload-btn:hover::before,
      .match-btn:hover::before {
        opacity: 1;
      }

      table {
        width: 100%;
        margin-top: 20px;
        border-collapse: separate;
        border-spacing: 0;
        border: 3px solid var(--primary-color);
      }

      table th,
      table td {
        padding: 10px 15px;
        text-align: left;
        border: 1px solid var(--primary-color);
        background-color: var(--background-color);
      }

      table thead {
        background-color: var(--primary-color);
        color: var(--background-color);
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      table tbody tr:nth-child(even) {
        background-color: rgba(61, 64, 91, 0.05);
      }

      table tbody tr:hover {
        background-color: var(--highlight-color);
      }

      table img {
        max-width: 100px;
        height: auto;
        border: 2px solid var(--secondary-color);
      }

      .accuracy-bar {
        width: 100%;
        height: 12px;
        background-color: var(--background-color);
        border: 1px solid var(--primary-color);
        overflow: hidden;
        margin-top: 5px;
      }

      .accuracy-bar span {
        display: block;
        height: 100%;
        background-color: var(--accent-color);
      }

      @media (max-width: 600px) {
        .container {
          padding: 20px;
          margin: 0 10px;
        }

        h1 {
          font-size: 1.8rem;
        }
      }

      @keyframes spinner {
        to {
          transform: rotate(360deg);
        }
      }

      .spinner {
        display: inline-block;
        width: 18px;
        height: 18px;
        border: 2px solid transparent;
        border-top-color: var(--background-color);
        border-right-color: var(--background-color);
        border-radius: 50%;
        animation: spinner 0.6s linear infinite;
        margin-left: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>
        <i class="fas fa-face-recognition"></i>
        Face Recognition
        <i class="fas fa-camera"></i>
      </h1>

      <div class="preview-container">
        <video id="webcam" autoplay></video>
        <img id="imagePreview" alt="Preview Image" />
      </div>

      <div class="btn-container">
        <button class="capture-btn" id="captureBtn">
          <i class="fas fa-camera"></i>
          Open Camera
        </button>
        <button
          class="upload-btn"
          onclick="document.getElementById('fileInput').click()"
        >
          <i class="fas fa-upload"></i>
          Upload Image
        </button>
        <button
          class="match-btn"
          id="matchBtn"
          onclick="sendImage()"
          style="display: none"
        >
          <i class="fas fa-search"></i>
          Match
        </button>
        <input
          type="file"
          id="fileInput"
          accept="image/*"
          style="display: none"
          onchange="previewUploadedImage(event)"
        />
      </div>

      <div id="matches"></div>
      <table id="matched-images">
        <thead>
          <tr>
            <th>#</th>
            <th>Image</th>
            <th>Title</th>
            <th>Accuracy</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <script>
      const video = document.getElementById("webcam");
      const imagePreview = document.getElementById("imagePreview");
      const matchBtn = document.getElementById("matchBtn");
      const captureBtn = document.getElementById("captureBtn");
      let currentBlob = null;
      let currentStream = null;

      function startWebcam() {
        if (currentStream) {
          currentStream.getTracks().forEach((track) => track.stop());
          currentStream = null;
          video.srcObject = null;
        }

        navigator.mediaDevices
          .getUserMedia({ video: true })
          .then((stream) => {
            currentStream = stream;
            video.srcObject = stream;
            video.style.display = "block";
            imagePreview.style.display = "none";
            matchBtn.style.display = "none";
            captureBtn.innerHTML =
              '<i class="fas fa-camera"></i> Capture Image';

            imagePreview.src = "";
          })
          .catch((error) => alert("Webcam not accessible. Error: " + error));
      }

      function captureImage() {
        video.pause();

        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        if (currentStream) {
          currentStream.getTracks().forEach((track) => {
            track.stop();
          });

          video.srcObject = null;
          currentStream = null;
        }

        video.style.display = "none";
        imagePreview.src = canvas.toDataURL("image/jpeg");
        imagePreview.style.display = "block";

        captureBtn.innerHTML = '<i class="fas fa-camera"></i> Open Camera';

        canvas.toBlob((blob) => {
          currentBlob = blob;
          matchBtn.style.display = "flex";
        });
      }

      function previewUploadedImage(event) {
        const file = event.target.files[0];
        if (file) {
          if (currentStream) {
            currentStream.getTracks().forEach((track) => track.stop());
            currentStream = null;
            video.srcObject = null;
            video.style.display = "none";
          }

          const reader = new FileReader();
          reader.onload = (e) => {
            imagePreview.src = e.target.result;
            video.style.display = "none";
            imagePreview.style.display = "block";

            captureBtn.innerHTML = '<i class="fas fa-camera"></i> Open Camera';

            const reader2 = new FileReader();
            reader2.onloadend = () => {
              currentBlob = new Blob([reader2.result]);
              matchBtn.style.display = "flex";
            };
            reader2.readAsArrayBuffer(file);
          };
          reader.readAsDataURL(file);
        }
      }

      function sendImage() {
        if (!currentBlob) {
          alert("Please capture or upload an image first.");
          return;
        }

        // Show spinner and update button text
        matchBtn.innerHTML = `
          <i class="fas fa-search"></i>
          Matching...
          <span class="spinner"></span>
        `;
        matchBtn.disabled = true;

        const formData = new FormData();
        formData.append("file", currentBlob, "uploaded_image.jpg");

        fetch("http://localhost:8000/process-image/", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            displayResults(data);
            matchBtn.innerHTML = `
              <i class="fas fa-search"></i>
              Match
            `;
            matchBtn.disabled = false;
          })
          .catch((error) => {
            console.error("Error:", error);
            matchBtn.innerHTML = `
              <i class="fas fa-search"></i>
              Match
            `;
            matchBtn.disabled = false;
          });
      }

      function displayResults(data) {
        const matchedImagesTable = document.querySelector(
          "#matched-images tbody"
        );
        matchedImagesTable.innerHTML = "";
        data.matched_images.forEach((imgBase64, index) => {
          const accuracy = data.accuracy[index];
          const title = data.matches[index] || `Person ${index + 1}`;
          const accuracyPercentage = Math.round(accuracy);

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${index + 1}</td>
            <td><img src="data:image/jpeg;base64,${imgBase64}" /></td>
            <td>${title}</td>
            <td>
              ${accuracyPercentage}%
              <div class="accuracy-bar">
                <span style="width: ${accuracyPercentage}%;"></span>
              </div>
            </td>
          `;
          matchedImagesTable.appendChild(row);
        });
      }

      captureBtn.addEventListener("click", function () {
        if (video.style.display === "block") {
          captureImage();
        } else {
          startWebcam();
        }
      });
    </script>
  </body>
</html>
